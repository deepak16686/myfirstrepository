# =============================================================================
# LEGACY standalone docker-compose for the backend service only.
# =============================================================================
# This file was used before the dev-stack consolidation (2026-02-17).
# The MAIN compose file is now at:
#   d:\Repos\ai-folder\dev-stack\docker-compose.yml
# which defines all 31 services under a single 'dev-stack' compose project.
#
# This file is kept for reference and quick local testing of the backend in
# isolation. It defines the devops-tools-backend service with all environment
# variables, volume mounts (config, Vault token, Claude CLI auth), and a
# chromadb-admin sidecar. It expects the 'ai-platform-net' and 'gitlab-net'
# Docker networks to already exist (created by the main compose file).
#
# To use the main stack instead:
#   docker compose -p dev-stack -f "D:/Repos/ai-folder/dev-stack/docker-compose.yml" up -d
# =============================================================================

version: '3.8'

services:
  devops-tools-backend:
    build: .
    container_name: devops-tools-backend
    ports:
      - "8003:8003"
    environment:
      # GitLab (use container name on shared network)
      - GITLAB_URL=http://gitlab-server
      - GITLAB_TOKEN=${GITLAB_TOKEN:-}

      # SonarQube
      - SONARQUBE_URL=http://ai-sonarqube:9000
      - SONARQUBE_USERNAME=admin
      - SONARQUBE_PASSWORD=${SONARQUBE_PASSWORD:-N7@qL9!fR2#XwA8$}

      # Trivy
      - TRIVY_URL=http://trivy-server:8080

      # Nexus
      - NEXUS_URL=http://ai-nexus:8081
      - NEXUS_USERNAME=admin
      - NEXUS_PASSWORD=${NEXUS_PASSWORD:-r}

      # GitHub/Gitea (free self-hosted GitHub Actions alternative)
      - GITHUB_URL=http://gitea-server:3000
      - GITHUB_TOKEN=${GITHUB_TOKEN:-5a2628e0c10773e0d1f4b10429d698037e4d5ae3}

      # ChromaDB
      - CHROMADB_URL=http://chromadb:8000

      # Ollama
      - OLLAMA_URL=http://ollama:11434

      # LLM Provider
      - LLM_PROVIDER=${LLM_PROVIDER:-claude-code}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-opus}
      - CLAUDE_TIMEOUT=${CLAUDE_TIMEOUT:-300}

      # Redis
      - REDIS_URL=redis://redis:6379/0

      # PostgreSQL
      - POSTGRES_URL=postgresql://modernization:modernization123@ai-postgres:5432/legacy_modernization

      # Jira
      - JIRA_URL=${JIRA_URL:-http://jira:8080}
      - JIRA_USERNAME=${JIRA_USERNAME:-}
      - JIRA_API_TOKEN=${JIRA_API_TOKEN:-}
      - JIRA_PROJECT_KEY=${JIRA_PROJECT_KEY:-DEVOPS}

      # Splunk (HEC uses HTTPS)
      - SPLUNK_URL=https://ai-splunk:8088
      - SPLUNK_TOKEN=${SPLUNK_TOKEN:-}

      # Jenkins
      - JENKINS_URL=http://jenkins-master:8080/jenkins
      - JENKINS_USERNAME=${JENKINS_USERNAME:-admin}
      - JENKINS_PASSWORD=${JENKINS_PASSWORD:-admin123}

      # Jenkins Git Server (Gitea - separate from GitLab to avoid dual CI trigger)
      - JENKINS_GIT_URL=http://gitea-server:3000
      - JENKINS_GIT_TOKEN=${JENKINS_GIT_TOKEN:-5a2628e0c10773e0d1f4b10429d698037e4d5ae3}

      # Vault (token read from /vault/file/.root-token)
      - VAULT_URL=http://vault:8200

      # Debug mode
      - DEBUG=false
    volumes:
      - devops-tools-config:/app/config
      - vault-data:/vault/file:ro
      - C:/Users/deepak/.claude:/root/.claude
    networks:
      - ai-platform-net
      - gitlab-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  chromadb-admin:
    image: fengzhichao/chromadb-admin
    container_name: chromadb-admin
    ports:
      - "3001:3001"
    networks:
      - ai-platform-net
    restart: unless-stopped

networks:
  ai-platform-net:
    external: true
  gitlab-net:
    external: true

volumes:
  devops-tools-config:
  vault-data:
    external: true
