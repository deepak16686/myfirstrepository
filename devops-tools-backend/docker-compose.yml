version: '3.8'

services:
  devops-tools-backend:
    build: .
    container_name: devops-tools-backend
    ports:
      - "8003:8003"
    environment:
      # GitLab (use container name on shared network)
      - GITLAB_URL=http://gitlab-server
      - GITLAB_TOKEN=${GITLAB_TOKEN:-}

      # SonarQube
      - SONARQUBE_URL=http://ai-sonarqube:9000
      - SONARQUBE_USERNAME=admin
      - SONARQUBE_PASSWORD=${SONARQUBE_PASSWORD:-N7@qL9!fR2#XwA8$}

      # Trivy
      - TRIVY_URL=http://trivy-server:8083

      # Nexus
      - NEXUS_URL=http://ai-nexus:8081
      - NEXUS_USERNAME=admin
      - NEXUS_PASSWORD=${NEXUS_PASSWORD:-}

      # ChromaDB
      - CHROMADB_URL=http://chromadb:8000

      # Ollama
      - OLLAMA_URL=http://ollama:11434

      # Redis
      - REDIS_URL=redis://redis:6379/0

      # PostgreSQL
      - POSTGRES_URL=postgresql://modernization:modernization123@ai-postgres:5432/legacy_modernization

      # Debug mode
      - DEBUG=false
    volumes:
      - devops-tools-config:/app/config
    networks:
      - ai-platform-net
      - gitlab-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  ai-platform-net:
    external: true
  gitlab-net:
    external: true

volumes:
  devops-tools-config:
